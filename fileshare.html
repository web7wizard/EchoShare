<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EcoShare 🌿</title>
  <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f0f4f2;
      --text: #659984;
      --accent: #c3e4d5;
      --button-bg: #5f8d78;
      --button-text: #ffffff;
      --panel-bg: #ffffff;
    }

    [data-theme="dark"] {
      --bg: #111;
      --text: #eee;
      --accent: #235e31;
      --button-bg: #222;
      --button-text: rgb(126, 192, 126);
      --panel-bg: #181818;
    }

    [data-theme="forest"] {
      --bg: #eafaf1;
      --text: #2f5233;
      --accent: #0a3a24;
      --button-bg: #2f5233;
      --button-text: #ffffff;
      --panel-bg: #ffffff;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Nunito', sans-serif;
    }

    body {
      display: flex;
      height: 100vh;
      background: var(--bg);
      color: var(--text);
      transition: background 0.4s, color 0.4s;
    }

    .left-panel {
      width: 40%;
      background: var(--accent);
      color: #fff;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 2rem;
      transition: background 0.4s;
      position: relative;
    }

    .left-panel h1 {
      font-size: 2.4rem;
      margin-bottom: 1rem;
    }

    .left-panel img {
      width: 120px;
      margin-bottom: 1.5rem;
      animation: float 4s ease-in-out infinite;
      border-radius: 50%;
    }

    .mode-switch {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
      flex-wrap: wrap;
      justify-content: center;
    }

    .mode-switch button {
      background: #fff;
      color: var(--accent);
      border: none;
      padding: 0.4rem 1rem;
      border-radius: 20px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .mode-switch button.active {
      background: var(--button-bg);
      color: var(--button-text);
    }

    .right-panel {
      width: 60%;
      background: var(--panel-bg);
      padding: 3rem;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: background 0.4s;
    }

    .panel-content {
      width: 100%;
      max-width: 420px;
      display: none;
      flex-direction: column;
      gap: 1rem;
    }

    .panel-content.active {
      display: flex;
    }

    .drop-zone {
      border: 2px dashed #ccc;
      padding: 1.5rem;
      text-align: center;
      border-radius: 10px;
      transition: border-color 0.3s;
      cursor: pointer;
    }

    .drop-zone.dragover {
      border-color: var(--accent);
      background: rgba(0, 255, 0, 0.05);
    }

    input[type="file"], input[type="text"] {
      padding: 0.8rem;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    button.submit {
      background: var(--button-bg);
      color: var(--button-text);
      border: none;
      padding: 0.8rem;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
    }

    button.submit:hover {
      opacity: 0.9;
    }

    .preview {
      text-align: center;
    }

    .preview img, .preview audio {
      max-width: 100%;
      margin-top: 1rem;
      border-radius: 8px;
    }

    .result {
      background: rgba(0,0,0,0.05);
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
      font-size: 0.9rem;
      color: var(--accent);
    }

    .expiry-setting {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
    }

    @keyframes float {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-8px);
      }
    }

    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }
      .left-panel, .right-panel {
        width: 100%;
        height: 50%;
      }
    }
    /* Top bar for theme toggle */
    .top-bar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      background: var(--panel-bg);
      padding: 0.6rem 1rem;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      border-bottom: 1px solid var(--accent);
      z-index: 999;
      box-sizing: border-box;
    }

    .theme-toggle {
      display: flex;
      gap: 0.6rem;
    }

    .theme-toggle button {
      background: var(--accent);
      border: none;
      padding: 0.4rem 1rem;
      border-radius: 6px;
      color: var(--button-text);
      font-size: 0.85rem;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .theme-toggle button.active {
      background: #fff;
      color: var(--accent);
      font-weight: bold;
    }

    /* Adjust content spacing due to fixed top bar */
    .left-panel, .right-panel {
      margin-top: 3.2rem;
    }
  </style>
</head>
<body data-theme="forest">

  <div class="top-bar">
    <div class="theme-toggle">
      <button data-theme="light">Light</button>
      <button data-theme="dark">Dark</button>
      <button data-theme="forest" class="active">Forest</button>
    </div>
  </div>

  <div class="left-panel">
    <!-- Replace with a new eco-friendly logo URL or SVG -->
    <img src="tree.png" alt="Eco Logo" />
    <h1>EcoShare</h1>
    <div class="mode-switch">
      <button id="senderBtn" class="active">Sender</button>
      <button id="receiverBtn">Receiver</button>
    </div>
  </div>

  <div class="right-panel">
    <form id="senderForm" class="panel-content active">
      <div class="drop-zone" id="dropZone">Drag & Drop file here or click to browse</div>
      <input type="file" id="fileInput" hidden required />
      <div class="expiry-setting">
        <label for="expirySelect">Expire In:</label>
        <select id="expirySelect">
          <option value="0">No Expiry</option>
          <option value="10">10 Minutes</option>
          <option value="60">1 Hour</option>
          <option value="1440">1 Day</option>
        </select>
      </div>
      <div class="preview" id="filePreview"></div>
      <button class="submit" type="submit">Upload & Get Code</button>
      <div class="result" id="codeDisplay"></div>
    </form>

    <div id="receiverSection" class="panel-content">
      <input type="text" id="fileCode" placeholder="Enter File Code" />
      <button class="submit" id="downloadBtn">Submit code</button>
      <div class="preview" id="receiverPreview"></div>
      <div class="result" id="linkDisplay"></div>
    </div>
  </div>

  <script>
    const sdk = new Appwrite.Client();
    sdk.setEndpoint('https://fra.cloud.appwrite.io/v1').setProject('6880958d002993e579b3');
    const storage = new Appwrite.Storage(sdk);

    const senderBtn = document.getElementById('senderBtn');
    const receiverBtn = document.getElementById('receiverBtn');
    const senderForm = document.getElementById('senderForm');
    const receiverSection = document.getElementById('receiverSection');
    const codeDisplay = document.getElementById('codeDisplay');
    const linkDisplay = document.getElementById('linkDisplay');
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const filePreview = document.getElementById('filePreview');
    const receiverPreview = document.getElementById('receiverPreview');
    const expirySelect = document.getElementById('expirySelect');

    senderBtn.onclick = () => {
      senderForm.classList.add('active');
      receiverSection.classList.remove('active');
      senderBtn.classList.add('active');
      receiverBtn.classList.remove('active');
    };

    receiverBtn.onclick = () => {
      senderForm.classList.remove('active');
      receiverSection.classList.add('active');
      senderBtn.classList.remove('active');
      receiverBtn.classList.add('active');
    };

    // Theme toggle buttons in top-bar
    document.querySelectorAll('.theme-toggle button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.theme-toggle button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const theme = btn.getAttribute('data-theme');
        document.body.setAttribute('data-theme', theme);
      });
    });

    dropZone.addEventListener('click', () => fileInput.click());

    dropZone.addEventListener('dragover', e => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));

    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      fileInput.files = e.dataTransfer.files;
      previewFile(fileInput.files[0]);
    });

    fileInput.onchange = () => previewFile(fileInput.files[0]);

    function previewFile(file) {
      if (!file) return;
      const reader = new FileReader();
      filePreview.innerHTML = '';
      if (file.type.startsWith('image/')) {
        reader.onload = () => filePreview.innerHTML = `<img src="${reader.result}" alt="Image Preview"/>`;
        reader.readAsDataURL(file);
      } else if (file.type.startsWith('audio/')) {
        reader.onload = () => filePreview.innerHTML = `<audio controls src="${reader.result}"></audio>`;
        reader.readAsDataURL(file);
      } else if (file.type === 'application/pdf') {
        filePreview.innerHTML = `<img src="https://cdn-icons-png.flaticon.com/512/337/337946.png" width="64"/> PDF File`;
      } else {
        filePreview.innerHTML = `📄 ${file.name}`;
      }
    }

    senderForm.onsubmit = async (e) => {
      e.preventDefault();
      const file = fileInput.files[0];
      if (!file) return;
      const expiryVal = expirySelect.value;
      let expiryText = "";
      if(expiryVal === "10") {
        expiryText = "10 Minutes";
      } else if(expiryVal === "60") {
        expiryText = "1 Hour";
      } else if(expiryVal === "1440") {
        expiryText = "1 Day";
      } else {
        expiryText = "No Expiry";
      }
      
      try {
        const uploaded = await storage.createFile('688096760038ed926d87', 'unique()', file);
        codeDisplay.innerHTML = `✅ Uploaded!<br><strong>${uploaded.$id}</strong><br><small>Expires: ${expiryText}</small><br><button id="copyBtn">Copy Code</button>`;
        
        // Add copy functionality
        document.getElementById('copyBtn').addEventListener('click', () => {
          navigator.clipboard.writeText(uploaded.$id);
          // Notification overlay
          const copyNotification = document.createElement('div');
          copyNotification.innerText = "Copied!";
          copyNotification.style.position = "fixed";
          copyNotification.style.top = "50%";
          copyNotification.style.left = "50%";
          copyNotification.style.transform = "translate(-50%, -50%)";
          copyNotification.style.padding = "1rem 2rem";
          copyNotification.style.background = "var(--accent)";
          copyNotification.style.color = "var(--button-text)";
          copyNotification.style.borderRadius = "8px";
          copyNotification.style.zIndex = "1000";
          document.body.appendChild(copyNotification);
          setTimeout(() => { copyNotification.remove(); }, 2000);
        });
      } catch (err) {
        codeDisplay.innerText = '❌ Upload failed: ' + err.message;
      }
    };

    document.getElementById('downloadBtn').onclick = async () => {
      const code = document.getElementById('fileCode').value.trim();
      if (!code) return;

      try {
        const fileMeta = await storage.getFile('688096760038ed926d87', code);
        const preview = fileMeta.mimeType.startsWith('image/') ? `<img src="${storage.getFileView('688096760038ed926d87', code)}" />` :
                        fileMeta.mimeType.startsWith('audio/') ? `<audio controls src="${storage.getFileView('688096760038ed926d87', code)}"></audio>` :
                        fileMeta.mimeType === 'application/pdf' ? `📄 PDF File` : `📦 ${fileMeta.name}`;
        receiverPreview.innerHTML = preview;
        const url = storage.getFileDownload('688096760038ed926d87', code);
        linkDisplay.innerHTML = `⬇️ <a href="${url.href}" target="_blank">Download File</a>`;
      } catch (err) {
        linkDisplay.innerText = '❌ Invalid code or file not found.';
        receiverPreview.innerHTML = '';
      }
    };
  </script>
</body>
</html>
